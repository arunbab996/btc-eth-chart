<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Internet Money</title>

  <!-- simple favicon -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23f7931a'/><text x='50' y='62' font-size='56' text-anchor='middle' fill='white'>฿</text></svg>">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
    :root{ --bg:#071018; --panel:#0d1114; --muted:#9aa3ad; --text:#dbe6ee; --accent:#f7931a; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    .root{height:100vh;display:flex;flex-direction:column}
    header.appbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .main{flex:1;display:flex;gap:16px;padding:18px;box-sizing:border-box}
    .chart-panel{flex:3;display:flex;flex-direction:column;border-radius:10px;padding:12px;overflow:hidden}
    .chart-canvas-wrap{flex:1;min-height:0;display:flex}
    canvas{width:100%!important;height:100%!important;display:block}
    .sidebar{flex:1;max-width:360px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.03);border-radius:10px;padding:12px}
    .coin-row{display:flex;align-items:center;gap:10px;cursor:pointer}
    .coin-row.inactive{opacity:0.55}
    .coin-icon{width:36px;height:36px}
    .small{font-size:12px;color:var(--muted)}
    .footer{height:36px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}
    @media(max-width:900px){ .main{padding:12px;flex-direction:column} .sidebar{width:100%;max-width:none} }
  </style>
</head>
<body>
  <div class="root">
    <header class="appbar">
      <div>
        <div style="font-weight:700">Magic Internet Money</div>
        <div class="small">Live Tick Chart — BTC / ETH · Source: Binance WebSocket</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <label class="small" for="currencySelector">Currency</label>
        <select id="currencySelector" aria-label="Currency selector">
          <option value="USDT">USDT</option>
          <option value="USD">USD</option>
          <option value="INR">INR</option>
        </select>
        <button id="pauseBtn">Pause</button>
      </div>
    </header>

    <div class="main">
      <section class="chart-panel card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Live Tick Chart — <span id="chartSymbol">BTC</span></div>
          <div class="small" id="last">Started: —</div>
        </div>

        <div class="chart-canvas-wrap">
          <canvas id="chart" aria-label="Live chart"></canvas>
        </div>

      </section>

      <aside class="sidebar">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:700">Watchlist</div>
            <div class="small">Live</div>
          </div>

          <div id="btcPanel" class="coin-row" role="button" aria-pressed="true">
            <svg class="coin-icon" viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="#f7931a"/><text x="32" y="38" font-size="28" font-family="Arial" text-anchor="middle" fill="#fff">฿</text></svg>
            <div style="flex:1">
              <div class="small">Bitcoin</div>
              <div id="btcLive" style="font-weight:700">—</div>
            </div>
            <div class="small" id="btcChange">—</div>
          </div>

          <hr style="border:none;height:8px">

          <div id="ethPanel" class="coin-row inactive" role="button" aria-pressed="false">
            <svg class="coin-icon" viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="#627eea"/><path d="M32 16 L22 32 L32 28 L42 32 Z M32 36 L22 32 L32 44 L42 32 Z" fill="#fff" transform="translate(0,0)"/></svg>
            <div style="flex:1">
              <div class="small">Ethereum</div>
              <div id="ethLive" style="font-weight:700">—</div>
            </div>
            <div class="small" id="ethChange">—</div>
          </div>
        </div>

        <div class="card">
          <div class="small">Options</div>
          <select id="maxPoints"><option value="200">200</option><option value="400" selected>400</option><option value="800">800</option></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="injectBtn">Inject sample</button>
            <button id="clearBtn">Clear</button>
          </div>
        </div>

      </aside>
    </div>

    <div class="footer">Magic Internet Money — live tick preview</div>
  </div>

<script>
// Wrap everything to avoid running before DOM ready
(function(){
  function onReady(fn){ if(document.readyState === 'complete' || document.readyState === 'interactive'){ setTimeout(fn,0); } else { document.addEventListener('DOMContentLoaded', fn); } }

  onReady(function(){
    // State
    var activeSymbol = 'BTC';
    var paused = false;
    var lastBTC = null, lastETH = null;
    var btcLabels = [], btcPrices = [], ethLabels = [], ethPrices = [];
    var MAX_POINTS = 400;
    var currencyRate = 1;

    // Chart setup
    var canvas = document.getElementById('chart');
    var ctx = canvas.getContext('2d');

    function safeGradient(ctxArg, area){
      try{
        if(!area || typeof area.top === 'undefined'){
          var g1 = ctxArg.createLinearGradient(0,0,0,200);
          g1.addColorStop(0,'rgba(247,147,26,0.18)'); g1.addColorStop(1,'rgba(247,147,26,0.02)');
          return g1;
        }
        var g = ctxArg.createLinearGradient(0, area.top, 0, area.bottom);
        g.addColorStop(0,'rgba(247,147,26,0.30)'); g.addColorStop(1,'rgba(247,147,26,0.03)');
        return g;
      }catch(e){
        var gf = ctxArg.createLinearGradient(0,0,0,200);
        gf.addColorStop(0,'rgba(247,147,26,0.18)'); gf.addColorStop(1,'rgba(247,147,26,0.02)');
        return gf;
      }
    }

    var chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'price', data: [], borderColor: '#f7931a', backgroundColor: null, borderWidth: 2.5, pointRadius: 0, tension: 0.28, fill: true }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 80, easing: 'linear' },
        interaction: { mode: 'index', intersect: false },
        plugins: { legend: { display: false } },
        scales: { x: { ticks: { color: '#9aa3ad' }, grid: { color: 'rgba(255,255,255,0.03)' } }, y: { ticks: { color: '#9aa3ad' }, grid: { color: 'rgba(255,255,255,0.03)' } } }
      }
    });

    // Helpers
    function toLocal(ts){ return new Date(ts).toLocaleTimeString(); }
    function fmt(n){ return n == null ? '—' : Number(n).toLocaleString(); }

    function pushTick(sym, price, qty, ts){
      var label = toLocal(ts || Date.now());
      if(sym === 'BTC'){
        btcLabels.push(label); btcPrices.push(price);
        if(btcLabels.length > MAX_POINTS){ btcLabels.shift(); btcPrices.shift(); }
      } else {
        ethLabels.push(label); ethPrices.push(price);
        if(ethLabels.length > MAX_POINTS){ ethLabels.shift(); ethPrices.shift(); }
      }
    }

    function updateGradient(){ try{ chart.data.datasets[0].backgroundColor = safeGradient(ctx, chart.chartArea); }catch(e){} }

    function redraw(){
      if(paused) return;
      if(activeSymbol === 'BTC'){
        chart.data.labels = btcLabels.slice();
        chart.data.datasets[0].data = btcPrices.map(function(v){ return v * currencyRate; });
      } else {
        chart.data.labels = ethLabels.slice();
        chart.data.datasets[0].data = ethPrices.map(function(v){ return v * currencyRate; });
      }
      updateGradient();
      chart.update('none');
      document.getElementById('btcLive').textContent = fmt(lastBTC ? lastBTC * currencyRate : null);
      document.getElementById('ethLive').textContent = fmt(lastETH ? lastETH * currencyRate : null);
      document.getElementById('last').textContent = 'Last update: ' + new Date().toLocaleTimeString();
    }

    // schedule via RAF for smoothness
    var rafFlag = false;
    function schedule(){ if(rafFlag) return; rafFlag = true; requestAnimationFrame(function(){ rafFlag = false; redraw(); }); }

    // REST fallback fetch (simple)
    async function fetchOnce(){
      try{
        var bResp = await fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=1');
        var eResp = await fetch('https://api.binance.com/api/v3/trades?symbol=ETHUSDT&limit=1');
        var bArr = await bResp.json();
        var eArr = await eResp.json();
        if(Array.isArray(bArr) && bArr.length){ var p = parseFloat(bArr[0].price || bArr[0].p); lastBTC = p; pushTick('BTC', p, 0, bArr[0].time || Date.now()); }
        if(Array.isArray(eArr) && eArr.length){ var p2 = parseFloat(eArr[0].price || eArr[0].p); lastETH = p2; pushTick('ETH', p2, 0, eArr[0].time || Date.now()); }
        schedule();
        return true;
      }catch(err){ console.error('REST fetch err', err); return false; }
    }

    var restTimer = null;
    function startRest(immediate){ if(restTimer) return; if(immediate) fetchOnce(); restTimer = setInterval(fetchOnce, 5000); }
    function stopRest(){ if(restTimer){ clearInterval(restTimer); restTimer = null; } }

    // WebSocket with fallback
    var socket = null;
    function startWS(){
      try{
        var url = 'wss://stream.binance.com/stream?streams=btcusdt@trade/ethusdt@trade';
        socket = new WebSocket(url);
        var opened = false;
        var t = setTimeout(function(){ if(!opened){ console.warn('WS not open — starting REST'); startRest(true); } }, 1500);
        socket.onopen = function(){ opened = true; clearTimeout(t); stopRest(); document.getElementById('last').textContent = 'Last update: websocket'; };
        socket.onmessage = function(evt){ try{ var msg = JSON.parse(evt.data); var data = msg.data || {}; var p = parseFloat(data.p || data.price); var ts = data.T || data.time || Date.now(); if(msg.stream && msg.stream.indexOf('btcusdt')===0){ lastBTC = p; pushTick('BTC', p, 0, ts); } else if(msg.stream && msg.stream.indexOf('ethusdt')===0){ lastETH = p; pushTick('ETH', p, 0, ts); } schedule(); }catch(e){ console.error('WS parse', e); } };
        socket.onerror = function(err){ console.error('WS err', err); startRest(true); };
        socket.onclose = function(ev){ console.warn('WS closed', ev); startRest(true); };
      }catch(e){ console.error('WS start err', e); startRest(true); }
    }

    // UI wiring
    document.getElementById('btcPanel').addEventListener('click', function(){ activeSymbol = 'BTC'; document.getElementById('btcPanel').classList.remove('inactive'); document.getElementById('ethPanel').classList.add('inactive'); document.getElementById('chartSymbol').textContent = 'BTC'; schedule(); });
    document.getElementById('ethPanel').addEventListener('click', function(){ activeSymbol = 'ETH'; document.getElementById('ethPanel').classList.remove('inactive'); document.getElementById('btcPanel').classList.add('inactive'); document.getElementById('chartSymbol').textContent = 'ETH'; schedule(); });

    document.getElementById('pauseBtn').addEventListener('click', function(){ paused = !paused; this.textContent = paused ? 'Resume' : 'Pause'; });
    document.getElementById('injectBtn').addEventListener('click', function(){ var now = Date.now(); for(var i=60;i>0;i--){ var ts = now - i*1000; var price = 60000 + Math.sin(i/6)*300 + (Math.random()-0.5)*60; lastBTC = Number(price.toFixed(2)); pushTick('BTC', lastBTC, 0, ts); } schedule(); });
    document.getElementById('clearBtn').addEventListener('click', function(){ btcLabels = []; btcPrices = []; ethLabels = []; ethPrices = []; schedule(); });
    document.getElementById('maxPoints').addEventListener('change', function(e){ MAX_POINTS = Number(e.target.value); });
    document.getElementById('currencySelector').addEventListener('change', function(e){ schedule(); });

    window.addEventListener('keydown', function(e){ if(e.key === '1'){ document.getElementById('btcPanel').click(); } else if(e.key === '2'){ document.getElementById('ethPanel').click(); } });

    // start
    startWS();
    // expose debug
    window._debug = { pushTick: pushTick, schedule: schedule, chart: chart };
  });
})();
</script>
</body>
</html>
