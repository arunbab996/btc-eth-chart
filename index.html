<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MIM | v18 </title>
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23f7931a'/><text x='50' y='62' font-size='56' text-anchor='middle' fill='white'>à¸¿</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- THEME --- */
    :root { 
      --bg: #000000;          
      --panel: #0b0b0b;       
      --border: #222;      
      --text: #e0e0e0; 
      --text-dim: #666;
      --accent: #FF3B30; 
      --green: #0ecb81;     
      --red: #f6465d;      
      --font: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --mono: 'JetBrains Mono', 'Menlo', monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; width: 100vw; overflow: hidden; }

    /* LAYOUT: DESKTOP DEFAULT */
    .dashboard {
      display: grid;
      height: 100%;
      width: 100%;
      grid-template-rows: 56px 1fr; /* Increased Header Height */
      grid-template-columns: 280px 1fr 320px;
      grid-template-areas: "head head head" "side main feed";
    }

    /* 1. HEADER */
    .appbar {
      grid-area: head; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
      overflow: hidden; white-space: nowrap; z-index: 10;
    }
    .brand-group { display: flex; align-items: center; gap: 12px; }
    .brand { font-weight: 700; font-size: 16px; letter-spacing: -0.3px; display: flex; align-items: center; gap: 8px; color: #fff; }
    .metric-group { display: flex; gap: 16px; margin-left: 20px; }
    .metric { display: flex; align-items: center; gap: 6px; font-family: var(--mono); font-size: 10px; color: var(--text-dim); border-left: 1px solid #222; padding-left: 12px; }
    .metric span { color: var(--text); font-weight: 600; }
    .logo-svg { width: 24px; height: 24px; filter: drop-shadow(0 0 5px rgba(247, 147, 26, 0.4)); }

    /* 2. SIDEBAR */
    .sidebar { 
      grid-area: side; background: #050505; border-right: 1px solid var(--border); 
      display: flex; flex-direction: column; height: 100%; overflow: hidden;
    }
    .sec-head { 
      flex: 0 0 auto; padding: 8px 12px; border-bottom: 1px solid var(--border); background: var(--panel);
    }
    #searchInput {
      width: 100%; background: #111; border: 1px solid #222; color: #fff;
      padding: 6px 10px; font-family: var(--mono); font-size: 11px; border-radius: 4px;
      outline: none; transition: border-color 0.2s;
    }
    #searchInput:focus { border-color: #444; }
    
    .coin-list { 
      flex: 0 1 auto; overflow-y: auto; border-bottom: 1px solid var(--border); 
      max-height: 60vh; min-height: 0; scrollbar-width: none;
    }
    .coin-list::-webkit-scrollbar { display: none; }

    .coin-row { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 10px 16px; cursor: pointer; border-left: 2px solid transparent; 
      font-size: 13px; transition: background 0.1s; border-bottom: 1px solid #0e0e0e;
    }
    .coin-row:hover { background: #111; }
    .coin-row.active { background: #111; border-left-color: var(--text); }
    .row-meta { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
    .row-price { font-family: var(--mono); font-size: 12px; }
    
    .terminal-panel { flex: 1; display: flex; flex-direction: column; background: #020202; min-height: 0; }
    .terminal-head { flex: 0 0 auto; background: #080808; color: #666; padding: 6px 16px; font-size: 9px; font-family: var(--mono); text-transform: uppercase; border-bottom: 1px solid #111; border-top: 1px solid #222; }
    .sys-log { flex: 1; padding: 12px; font-family: var(--mono); font-size: 10px; overflow-y: hidden; color: #444; display: flex; flex-direction: column-reverse; }
    .log-line { margin-bottom: 3px; word-break: break-all; line-height: 1.4; }
    .cursor { display: inline-block; width: 6px; height: 10px; background: var(--accent); animation: blink 1s infinite; vertical-align: middle; margin-left: 4px; }
    @keyframes blink { 50% { opacity: 0; } }

    /* 3. MAIN */
    .main-panel { grid-area: main; display: flex; flex-direction: column; position: relative; min-width: 0; min-height: 0; overflow: hidden; }
    
    .chart-toolbar {
      flex: 0 0 48px; /* Increased Height for Spacing */
      border-bottom: 1px solid var(--border); background: var(--panel);
      display: flex; align-items: center; padding: 0 16px; gap: 8px;
    }
    .tf-btn {
      background: transparent; border: 1px solid #333; color: #666; font-size: 11px;
      padding: 5px 12px; border-radius: 4px; cursor: pointer; font-family: var(--font);
      font-weight: 600; transition: 0.2s; white-space: nowrap;
    }
    .tf-btn.active { background: #222; color: #fff; border-color: #fff; }
    .tf-btn.live-active { background: #081a0f; color: var(--green); border-color: var(--green); box-shadow: 0 0 5px rgba(14,203,129,0.2); }
    .divider { width: 1px; height: 16px; background: #333; margin: 0 4px; }

    /* KPI */
    .kpi-bar { 
      flex: 0 0 76px; display: grid; grid-template-columns: repeat(4, 1fr); 
      border-bottom: 1px solid var(--border); background: var(--panel); 
    }
    .kpi-box { padding: 0 24px; border-right: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
    .kpi-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; white-space: nowrap; }
    .kpi-val { font-family: var(--mono); font-size: 20px; font-weight: 500; letter-spacing: -0.5px; white-space: nowrap; }
    .kpi-sub { font-size: 11px; color: #555; margin-top: 2px; }

    .chart-container { flex: 1; position: relative; width: 100%; background: var(--bg); padding-bottom: 10px; min-height: 0; }

    /* 4. FEED */
    .feed-panel { grid-area: feed; background: #050505; border-left: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    .feed-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; }
    .trade-row { display: flex; align-items: center; justify-content: space-between; height: 28px; padding: 0 12px; position: relative; font-family: var(--mono); font-size: 11px; color: var(--text-dim); border-bottom: 1px solid #0e0e0e; overflow: hidden; }
    .vol-bar { position: absolute; top: 0; bottom: 0; right: 0; opacity: 0.15; z-index: 0; transition: width 0.2s; }
    .row-content { position: relative; z-index: 1; display: flex; width: 100%; justify-content: space-between; }
    
    .up { color: var(--green); } .down { color: var(--red); }

    /* --- MOBILE OPTIMIZATIONS --- */
    @media (max-width: 900px) {
      body { height: auto; overflow-y: auto; }
      .dashboard { display: flex; flex-direction: column; height: auto; overflow: visible; }
      
      /* Order Stack */
      .appbar { order: 1; position: sticky; top: 0; border-bottom: none; }
      .main-panel { order: 2; height: auto; display: block; }
      .sidebar { order: 3; height: auto; border-right: none; border-bottom: 1px solid var(--border); }
      .feed-panel { order: 4; height: 400px; border-left: none; }

      .metric-group { display: none; }
      
      /* Spacing Fix for Congestion */
      .chart-toolbar { 
        margin-top: 4px; /* Separation from Header */
        overflow-x: auto; justify-content: flex-start; padding-left: 12px; 
      }
      
      /* KPI Compact */
      .kpi-bar { height: auto; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border); }
      .kpi-box { padding: 12px 16px; border-bottom: 1px solid var(--border); }
      .kpi-box:nth-child(2n) { border-right: none; }
      
      /* Chart Compact */
      .chart-container { 
        height: 260px; min-height: 260px;
        padding-bottom: 0; 
      }
      
      /* Watchlist */
      .coin-list { max-height: none; height: auto; }
      .terminal-panel { height: 200px; }
    }
  </style>
</head>
<body>

  <div class="dashboard">
    <header class="appbar">
      <div class="brand-group">
        <svg class="logo-svg" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="15" fill="#f7931a"/><path d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.114-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.402-1.594-4.212 1.132-.26 1.986-.998 2.214-2.522zm-3.96 5.603c-.54 2.16-4.18 1.99-5.36 1.697l.956-3.832c1.18.294 4.966.877 4.404 2.135zm.536-5.632c-.493 1.973-3.535 1.777-4.522 1.532l.868-3.48c.987.245 4.155.702 3.654 1.948z" fill="#fff"/></svg>
        <span class="brand">Magic Internet Money</span>
      </div>
      <div class="brand-group metric-group">
        <div class="metric">LATENCY: <span id="ping">12ms</span></div>
        <div class="metric">GAS: <span id="gas">15</span></div>
      </div>
      <div>
        <select id="currency" style="background:#111; color:#fff; border:1px solid #333; padding:4px 8px; font-size:11px; border-radius:4px; font-family:var(--mono)">
          <option value="USDT">USDT</option>
          <option value="INR">INR</option>
        </select>
      </div>
    </header>

    <main class="main-panel">
      <div class="chart-toolbar">
        <button class="tf-btn live-active" id="btn-live" onclick="setMode('LIVE')">LIVE</button>
        <div class="divider"></div>
        <button class="tf-btn" id="btn-1m" onclick="setMode('1m')">1m</button>
        <button class="tf-btn" id="btn-5m" onclick="setMode('5m')">5m</button>
        <button class="tf-btn" id="btn-15m" onclick="setMode('15m')">15m</button>
        <button class="tf-btn" id="btn-1h" onclick="setMode('1h')">1H</button>
        <div class="divider"></div>
        <button class="tf-btn" id="smaBtn" onclick="toggleSMA()">SMA: OFF</button>
      </div>

      <div class="kpi-bar">
        <div class="kpi-box">
          <div class="kpi-lbl">Mark Price</div>
          <div id="kpiPrice" class="kpi-val" style="color:#fff">---</div>
          <div class="kpi-sub">Real-time</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-lbl">24h Change</div>
          <div id="kpiChange" class="kpi-val">---</div>
          <div class="kpi-sub">Rolling Window</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-lbl">24h Volume</div>
          <div id="kpiVol" class="kpi-val">---</div>
          <div class="kpi-sub">USDT Notional</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-lbl">24h High</div>
          <div id="kpiHigh" class="kpi-val">---</div>
          <div class="kpi-sub">Global Average</div>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </main>

    <aside class="sidebar">
      <div class="sec-head">
        <input id="searchInput" placeholder="FILTER ASSETS..." autocomplete="off">
      </div>
      <div id="coinList" class="coin-list"></div>
      <div class="terminal-panel">
        <div class="terminal-head">Terminal Output_</div>
        <div class="sys-log" id="sysLogContainer">
          <div style="margin-top:auto">
            <span id="logOutput"></span><span class="cursor"></span>
          </div>
        </div>
      </div>
    </aside>

    <aside class="feed-panel">
      <div class="sec-head" style="justify-content:flex-start; gap:10px">
        <span>Order Tape</span>
        <span style="font-size:9px; opacity:0.5; border:1px solid #333; padding:2px 4px; border-radius:3px">REAL-TIME</span>
      </div>
      <div id="tradeFeed" class="feed-scroll"></div>
    </aside>
  </div>

<script>
(function(){
  const COINS = ['BTC', 'ETH', 'SOL', 'BNB', 'XRP', 'DOGE', 'ADA', 'AVAX', 'DOT', 'LINK', 'LTC', 'MATIC'];
  const COLORS = {
    'BTC': '#f7931a', 'ETH': '#627eea', 'SOL': '#14F195', 'BNB': '#F0B90B',
    'XRP': '#ffffff', 'DOGE': '#cb9800', 'ADA': '#0033ad', 'AVAX': '#e84142',
    'DOT': '#e6007a', 'LINK': '#2a5ada', 'LTC': '#345D9D', 'MATIC': '#8247E5'
  };
  
  const STATE = { active: 'BTC', currency: 'USDT', rate: 1, mode: 'LIVE', showSMA: false, coins: {} };
  const isMobile = window.innerWidth < 900;

  const ctx = document.getElementById('chart').getContext('2d');
  
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Price',
          data: [],
          borderColor: '#fff',
          borderWidth: 2,
          pointRadius: 0,
          backgroundColor: (ctx) => {
            const g = ctx.chart.ctx.createLinearGradient(0,0,0,400);
            g.addColorStop(0, 'rgba(255,255,255,0.2)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            return g;
          },
          fill: true,
          tension: 0.2
        },
        {
          label: 'SMA',
          data: [],
          borderColor: '#F0B90B',
          borderWidth: 1,
          pointRadius: 0,
          fill: false,
          tension: 0.4,
          hidden: true
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false, 
      layout: { padding: { left: 0, right: 10, top: 20, bottom: isMobile ? 10 : 30 } },
      animation: { duration: 0 },
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false } },
      scales: {
        x: { 
          display: true, grid: { display: false, borderColor: '#333' },
          ticks: { 
            // CLEAN X-AXIS
            color: '#666', 
            font: { family: '-apple-system, sans-serif', size: 10 }, 
            maxTicksLimit: isMobile ? 4 : 8, 
            maxRotation: 0, autoSkip: true, padding: 10 
          }
        },
        y: { 
          position: 'right', grid: { color: '#1a1a1a' }, 
          ticks: { color: '#555', font: { family: '-apple-system, sans-serif', size: 10 }, callback: v => v.toLocaleString() } 
        }
      }
    }
  });

  function calculateSMA(data, window) {
    if(!data || data.length < window) return [];
    let sma = [];
    for(let i=0; i<data.length; i++) {
      if(i < window-1) { sma.push(null); continue; }
      let sum = 0;
      for(let j=0; j<window; j++) sum += data[i-j];
      sma.push(sum/window);
    }
    return sma;
  }

  function log(msg, type='SYS') {
    const wrapper = document.getElementById('sysLogContainer');
    const div = document.createElement('div');
    div.className = 'log-line';
    const ts = new Date().toLocaleTimeString('en-GB'); 
    let color = '#555';
    if(type === 'NET') color = '#0ecb81';
    if(type === 'ERR') color = '#f6465d';
    div.innerHTML = `<span style="color:${color}">[${type}]</span> <span style="opacity:0.6">${ts}</span> ${msg}`;
    wrapper.insertBefore(div, wrapper.firstChild);
    if(wrapper.children.length > 50) wrapper.lastChild.remove();
  }

  async function fetchMarketData() {
    try {
      const res = await fetch('https://api.binance.com/api/v3/ticker/24hr');
      const allStats = await res.json();
      COINS.forEach(sym => {
        const pair = `${sym}USDT`;
        const stat = allStats.find(s => s.symbol === pair);
        if(stat) {
          STATE.coins[sym].stats = {
            change: parseFloat(stat.priceChangePercent),
            vol: parseFloat(stat.quoteVolume),
            high: parseFloat(stat.highPrice)
          };
        }
      });
    } catch(e) {}
  }

  async function fetchHistory(sym, tf) {
    if(tf === 'LIVE') return null; 
    log(`Loading ${tf} data...`, 'NET');
    try {
      const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}USDT&interval=${tf}&limit=100`);
      const data = await res.json();
      const prices = [];
      const labels = [];
      data.forEach(k => {
        prices.push(parseFloat(k[4]));
        const t = new Date(k[0]);
        // Format Time Cleanly
        const tStr = isMobile 
            ? t.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) 
            : t.toLocaleTimeString('en-GB');
        labels.push(tStr);
      });
      return { prices, labels };
    } catch(e) { return null; }
  }

  window.setMode = async function(mode) {
    STATE.mode = mode;
    document.querySelectorAll('.tf-btn').forEach(b => { b.classList.remove('active'); b.classList.remove('live-active'); });
    const btnId = mode === 'LIVE' ? 'btn-live' : `btn-${mode}`;
    document.getElementById(btnId).classList.add(mode === 'LIVE' ? 'live-active' : 'active');

    if(mode === 'LIVE') {
      const coin = STATE.coins[STATE.active];
      renderChart(coin.liveHistory, coin.liveLabels, true);
    } else {
      const data = await fetchHistory(STATE.active, mode);
      if(data) renderChart(data.prices, data.labels, false);
    }
  }

  window.toggleSMA = function() {
    STATE.showSMA = !STATE.showSMA;
    document.getElementById('smaBtn').innerText = `SMA: ${STATE.showSMA ? 'ON' : 'OFF'}`;
    chart.data.datasets[1].hidden = !STATE.showSMA;
    if(STATE.showSMA) {
      chart.data.datasets[1].data = calculateSMA(chart.data.datasets[0].data, 20);
    }
    chart.update();
  }

  function renderChart(data, labels, animate) {
    chart.options.animation = animate ? { duration: 1500, easing: 'linear' } : false;
    chart.data.datasets[0].data = data;
    chart.data.labels = labels;
    
    const c = COLORS[STATE.active] || '#ffffff';
    chart.data.datasets[0].borderColor = c;
    chart.data.datasets[0].backgroundColor = (ctx) => {
      const g = ctx.chart.ctx.createLinearGradient(0,0,0,400);
      g.addColorStop(0, c+'33'); g.addColorStop(1, c+'00');
      return g;
    };

    if(STATE.showSMA) {
      chart.data.datasets[1].data = calculateSMA(data, 20);
    }
    chart.update();
  }

  async function init() {
    log('System Boot...', 'SYS');
    const list = document.getElementById('coinList');
    COINS.forEach(sym => {
      STATE.coins[sym] = { price: 0, liveHistory: [], liveLabels: [], lastBufferPrice: null, stats: { change:0, vol:0, high:0 } };
      const row = document.createElement('div');
      row.className = 'coin-row';
      row.id = `row-${sym}`;
      row.onclick = () => loadCoin(sym);
      row.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="https://cdn.jsdelivr.net/npm/cryptocurrency-icons@0.18.1/svg/color/${sym.toLowerCase()}.svg" width="16"><b style="font-family:var(--mono)">${sym}</b></div><div class="row-meta"><div id="p-${sym}" class="row-price">...</div></div>`;
      list.appendChild(row);
    });

    await fetchMarketData();
    const promises = COINS.map(async (sym) => {
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}USDT&interval=1m&limit=50`);
        const data = await res.json();
        const coin = STATE.coins[sym];
        data.forEach(k => {
          coin.liveHistory.push(parseFloat(k[4]));
          const t = new Date(k[0]);
          const tStr = isMobile 
            ? t.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) 
            : t.toLocaleTimeString('en-GB');
          coin.liveLabels.push(tStr);
          coin.price = parseFloat(k[4]);
        });
        document.getElementById(`p-${sym}`).innerText = fmt(coin.price);
      } catch(e) {}
    });
    await Promise.all(promises);
    
    await loadCoin('BTC', false);
    connect();
    setInterval(plotTick, 2000);
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const val = e.target.value.toUpperCase();
      COINS.forEach(sym => {
        document.getElementById(`row-${sym}`).style.display = sym.includes(val) ? 'flex' : 'none';
      });
    });
  }

  async function loadCoin(sym, doLog = true) {
    document.querySelectorAll('.coin-row').forEach(r => r.classList.remove('active'));
    document.getElementById(`row-${sym}`).classList.add('active');
    STATE.active = sym;
    if(doLog) log(`Feed -> ${sym}`, 'SYS');
    document.getElementById('tradeFeed').innerHTML = ''; 
    
    if(STATE.mode === 'LIVE') {
      const coin = STATE.coins[sym];
      renderChart(coin.liveHistory, coin.liveLabels, false);
      setTimeout(() => chart.options.animation = { duration: 1500, easing: 'linear' }, 100);
    } else {
      const data = await fetchHistory(sym, STATE.mode);
      if(data) renderChart(data.prices, data.labels, false);
    }
    updateKPI(STATE.coins[sym]);
  }

  function handleTick(sym, price) {
    STATE.coins[sym].price = price;
    STATE.coins[sym].lastBufferPrice = price; 
    const el = document.getElementById(`p-${sym}`);
    if(el) {
      el.textContent = fmt(price);
      el.style.color = '#fff';
    }
  }

  function plotTick() {
    COINS.forEach(sym => {
      const coin = STATE.coins[sym];
      if(coin.lastBufferPrice !== null) {
        const t = new Date();
        const tStr = isMobile 
            ? t.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) 
            : t.toLocaleTimeString('en-GB');
        
        coin.liveHistory.push(coin.lastBufferPrice);
        coin.liveLabels.push(tStr);
        if(coin.liveHistory.length > 50) { 
          coin.liveHistory.shift(); 
          coin.liveLabels.shift(); 
        }
      }
    });

    if(STATE.mode === 'LIVE') {
      const activeCoin = STATE.coins[STATE.active];
      if(activeCoin.liveHistory.length > 0) {
        chart.data.datasets[0].data = activeCoin.liveHistory;
        chart.data.labels = activeCoin.liveLabels;
        const min = Math.min(...activeCoin.liveHistory);
        const max = Math.max(...activeCoin.liveHistory);
        const pad = (max - min) * 0.1;
        chart.options.scales.y.min = min - pad;
        chart.options.scales.y.max = max + pad;
        if(STATE.showSMA) chart.data.datasets[1].data = calculateSMA(activeCoin.liveHistory, 20);
        chart.update();
      }
    }
  }

  function updateKPI(coin) {
    document.getElementById('kpiPrice').textContent = fmt(coin.price);
    if(coin.stats) {
      const chg = coin.stats.change;
      const chgEl = document.getElementById('kpiChange');
      chgEl.textContent = (chg > 0 ? '+' : '') + chg.toFixed(2) + '%';
      chgEl.style.color = chg >= 0 ? '#0ecb81' : '#f6465d';
      document.getElementById('kpiVol').innerText = (coin.stats.vol/1e6).toFixed(1) + 'M';
      document.getElementById('kpiHigh').innerText = fmt(coin.stats.high);
    }
  }

  function addTrade(sym, price, qty, isMaker) {
    if(sym !== STATE.active) return;
    const val = price * qty;
    const widthPct = Math.min((val / 50000) * 100, 100); 
    const sideClass = isMaker ? 'down' : 'up'; 
    const barColor = isMaker ? 'rgba(246,70,93,0.15)' : 'rgba(14,203,129,0.15)';
    
    const row = document.createElement('div');
    row.className = 'trade-row';
    const bar = document.createElement('div');
    bar.className = 'vol-bar';
    bar.style.width = widthPct + '%';
    bar.style.background = barColor;
    
    const content = document.createElement('div');
    content.className = 'row-content';
    const time = new Date().toLocaleTimeString('en-GB');
    
    content.innerHTML = `<span>${time}</span><span class="${sideClass}">${fmt(price)}</span><span>${val.toFixed(0)}</span>`;
    row.appendChild(bar); row.appendChild(content);
    
    const feed = document.getElementById('tradeFeed');
    feed.prepend(row);
    if(feed.children.length > 40) feed.lastChild.remove();
  }

  function connect() {
    log('Connecting WS...', 'NET');
    const streams = COINS.map(c => c.toLowerCase()+'usdt@trade').join('/');
    const ws = new WebSocket(`wss://stream.binance.com/stream?streams=${streams}`);
    ws.onopen = () => log('Stream Active', 'NET');
    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      if(!msg.data) return;
      const { s, p, q, m } = msg.data;
      const sym = s.replace('USDT','');
      handleTick(sym, parseFloat(p));
      addTrade(sym, parseFloat(p), parseFloat(q), m);
    };
  }

  function fmt(n) { return (n * STATE.rate).toLocaleString('en-US', { style:'currency', currency: STATE.currency==='USDT'?'USD':'INR' }); }

  document.getElementById('currency').onchange = (e) => {
    STATE.currency = e.target.value; STATE.rate = STATE.currency === 'INR' ? 86.5 : 1;
    loadCoin(STATE.active); 
  };

  init();

})();
</script>
</body>
</html>
