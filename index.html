<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Internet Money</title>
  
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23f7931a'/><text x='50' y='62' font-size='56' text-anchor='middle' fill='white'>฿</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
    /* MATTE BLACK THEME */
    :root { 
      --bg: #141414;        
      --panel: #1E1E1E;     
      --border: #333333;    
      --text-main: #E0E0E0; 
      --text-dim: #888888;  
      --green: #3bd671; 
      --red: #ff5b5b;
    }

    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text-main); font-family: 'Inter', system-ui, sans-serif; }
    
    .root { height: 100vh; display: flex; flex-direction: column; }
    
    /* Header */
    header.appbar { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; border-bottom: 1px solid var(--border); background: var(--panel); }
    
    /* Layout */
    .main { flex: 1; display: flex; gap: 20px; padding: 20px; overflow: hidden; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; }
    
    /* Chart Area */
    .chart-panel { flex: 3; padding: 20px; position: relative; min-width: 0; }
    .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }
    
    /* Sidebar */
    .sidebar { flex: 1; max-width: 360px; display: flex; flex-direction: column; gap: 16px; min-width: 280px; }
    
    /* Coin Rows */
    .coin-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    .coin-row:hover { background: rgba(255,255,255,0.03); }
    .coin-row.active { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.1); }
    .coin-icon { width: 32px; height: 32px; border-radius: 50%; }
    
    /* Typography */
    .label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
    .price-lg { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; font-variant-numeric: tabular-nums; }
    .price-sm { font-weight: 600; font-variant-numeric: tabular-nums; }
    
    /* Controls */
    input, select { background: #000; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 6px; outline: none; }
    button { background: #333; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    button:hover { background: #444; }
    button.primary { background: var(--text-main); color: #000; }
    
    /* Utils */
    .flex-row { display: flex; align-items: center; gap: 10px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #444; margin-right: 8px; }

    @media(max-width: 900px){ .main{ flex-direction: column; overflow-y: auto; } .chart-panel { height: 400px; flex: none; } }
  </style>
</head>
<body>

  <div class="root">
    <header class="appbar">
      <div class="flex-row">
        <div id="statusDot" class="status-dot" title="Connecting..."></div>
        <div style="font-weight:800; letter-spacing:-0.5px">Magic Internet Money</div>
      </div>
      
      <div class="flex-row">
        <select id="currencySelector">
          <option value="USDT">USDT</option>
          <option value="USD">USD</option>
          <option value="INR">INR</option>
        </select>
        <button id="pauseBtn">Pause</button>
      </div>
    </header>

    <div class="main">
      
      <section class="chart-panel card">
        <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:flex-end">
          <div>
            <div class="label" style="margin-bottom:6px">Live Price</div>
            <div class="flex-row">
              <span id="bigPrice" class="price-lg">Loading...</span>
              <span id="bigChange" style="font-size:16px; font-weight:600">—</span>
            </div>
          </div>
          <div class="label" id="activeSymbolName">BTC / USDT</div>
        </div>

        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
      </section>

      <aside class="sidebar">
        <div class="card" style="padding:12px">
          <div class="flex-row">
            <input type="text" id="newCoinInput" placeholder="Symbol (e.g. SOL)" style="flex:1; text-transform:uppercase; font-weight:600">
            <button id="addCoinBtn" class="primary">Add</button>
          </div>
        </div>

        <div class="card" style="flex:1; padding:0; overflow:hidden">
          <div style="padding:16px; display:flex; justify-content:space-between; border-bottom:1px solid var(--border)">
            <div class="label">Watchlist</div>
            <div class="label" style="cursor:pointer" id="clearBtn">Reset</div>
          </div>
          <div id="watchlist" style="flex:1; overflow-y:auto; padding:8px"></div>
        </div>
      </aside>
    </div>
  </div>

<script>
(function(){
  // --- CONFIG ---
  const CONFIG = {
    colors: { grid: '#2A2A2A', text: '#666', up: '#3bd671', down: '#ff5b5b' },
    brandColors: { 
      'BTC': '#f7931a', // Bitcoin Orange
      'ETH': '#627eea', // Ethereum Blue
      'SOL': '#14F195', 
      'DOGE': '#cb9800' 
    },
    defaultColor: '#ffffff',
    maxPoints: 100,
    defaultCoins: ['BTC', 'ETH']
  };

  // --- STATE ---
  let state = {
    activeSymbol: 'BTC',
    currency: 'USDT',
    rate: 1,
    paused: false,
    coins: {} 
  };

  // --- UI ELEMENTS ---
  const els = {
    chartCtx: document.getElementById('chart').getContext('2d'),
    watchlist: document.getElementById('watchlist'),
    bigPrice: document.getElementById('bigPrice'),
    bigChange: document.getElementById('bigChange'),
    activeName: document.getElementById('activeSymbolName'),
    status: document.getElementById('statusDot')
  };

  // --- CHART INITIALIZATION ---
  // Helper to create gradient based on current active color
  function getGradient(ctx, area, color) {
    const gradient = ctx.createLinearGradient(0, area.top, 0, area.bottom);
    gradient.addColorStop(0, color + '60'); // 40% opacity at top
    gradient.addColorStop(1, color + '00'); // 0% opacity at bottom
    return gradient;
  }

  const chart = new Chart(els.chartCtx, {
    type: 'line',
    data: {
      labels: [], 
      datasets: [{
        label: 'Price',
        data: [],
        borderColor: CONFIG.brandColors.BTC, // Default start
        borderWidth: 2,
        tension: 0.4, 
        pointRadius: 0,
        fill: true,
        backgroundColor: null // Set dynamically
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false }, tooltip: { enabled: true, intersect: false } },
      scales: {
        x: { 
          display: true, // X-AXIS ENABLED
          ticks: { 
            maxTicksLimit: 6, 
            color: '#444', 
            maxRotation: 0 
          },
          grid: { display: false }
        },
        y: {
          position: 'right',
          grid: { color: CONFIG.colors.grid },
          ticks: { color: CONFIG.colors.text, callback: (v) => v.toLocaleString() }
        }
      }
    }
  });

  // --- LOGIC ---

  function initCoin(symbol) {
    if(state.coins[symbol]) return;
    
    state.coins[symbol] = {
      price: 0, prev: 0,
      history: [], labels: [],
      // Assign brand color or default
      color: CONFIG.brandColors[symbol] || CONFIG.defaultColor
    };

    renderWatchlistRow(symbol);
    subscribeWS(symbol);
  }

  function renderWatchlistRow(symbol) {
    const div = document.createElement('div');
    div.className = `coin-row ${symbol === state.activeSymbol ? 'active' : ''}`;
    div.id = `row-${symbol}`;
    div.onclick = () => switchCoin(symbol);
    
    const icon = `https://cdn.jsdelivr.net/npm/cryptocurrency-icons@0.18.1/svg/color/${symbol.toLowerCase()}.svg`;
    
    div.innerHTML = `
      <img src="${icon}" class="coin-icon" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg'">
      <div style="flex:1">
        <div style="font-weight:600">${symbol}</div>
        <div class="label" style="font-size:10px">USDT</div>
      </div>
      <div style="text-align:right">
        <div class="price-sm" id="price-${symbol}">...</div>
        <div class="label" id="change-${symbol}">—</div>
      </div>
    `;
    els.watchlist.appendChild(div);
  }

  function switchCoin(symbol) {
    // 1. Highlight UI
    document.querySelectorAll('.coin-row').forEach(r => r.classList.remove('active'));
    const row = document.getElementById(`row-${symbol}`);
    if(row) row.classList.add('active');

    state.activeSymbol = symbol;
    els.activeName.textContent = `${symbol} / ${state.currency}`;

    // 2. Update Chart Theme (Color)
    const coin = state.coins[symbol];
    chart.data.datasets[0].borderColor = coin.color;
    // We clear the background so it regenerates with new color on next render
    chart.data.datasets[0].backgroundColor = (context) => {
      const {ctx, chartArea} = context.chart;
      if (!chartArea) return null;
      return getGradient(ctx, chartArea, coin.color);
    };

    // 3. Update Data
    if (coin.history.length > 0) {
      updateChart(coin.labels, coin.history);
      updateHeader(coin.price, coin.prev);
    } else {
      updateChart([], []);
      els.bigPrice.textContent = "Loading...";
    }
  }

  function handleTick(symbol, price, time) {
    if(!state.coins[symbol]) return;
    const coin = state.coins[symbol];
    
    coin.prev = coin.price;
    coin.price = price;
    
    const localPrice = price * state.rate;
    const timeLabel = new Date(time).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute:'2-digit', second:'2-digit' });

    coin.history.push(localPrice);
    coin.labels.push(timeLabel);
    
    if(coin.history.length > CONFIG.maxPoints) {
      coin.history.shift();
      coin.labels.shift();
    }

    // Sidebar Updates
    const pEl = document.getElementById(`price-${symbol}`);
    const cEl = document.getElementById(`change-${symbol}`);
    if(pEl) pEl.textContent = fmt(price);
    
    if(cEl && coin.prev) {
      const pct = ((price - coin.prev)/coin.prev) * 100;
      cEl.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
      cEl.style.color = pct >= 0 ? CONFIG.colors.up : CONFIG.colors.down;
    }

    // Chart Updates (Active Only)
    if(symbol === state.activeSymbol && !state.paused) {
      updateHeader(coin.price, coin.prev);
      updateChart(coin.labels, coin.history);
    }
  }

  function updateChart(labels, data) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    
    if(data.length > 2) {
      const min = Math.min(...data);
      const max = Math.max(...data);
      const padding = (max - min) * 0.1;
      chart.options.scales.y.min = min - padding;
      chart.options.scales.y.max = max + padding;
    }
    chart.update('none');
  }

  function updateHeader(price, prev) {
    els.bigPrice.textContent = fmt(price);
    document.title = `${fmt(price)} ${state.activeSymbol}`;
    if(prev) {
      const pct = ((price - prev)/prev) * 100;
      els.bigChange.textContent = (pct >= 0 ? '+' : '') + pct.toFixed(2) + '%';
      els.bigChange.style.color = pct >= 0 ? CONFIG.colors.up : CONFIG.colors.down;
    }
  }

  // --- WEBSOCKET ---
  let ws;
  function connect() {
    const streams = CONFIG.defaultCoins.map(c => c.toLowerCase()+'usdt@trade').join('/');
    ws = new WebSocket(`wss://stream.binance.com/stream?streams=${streams}`);
    
    ws.onopen = () => { els.status.style.background = CONFIG.colors.up; els.status.title = "Online"; };
    ws.onclose = () => { els.status.style.background = CONFIG.colors.down; setTimeout(connect, 2000); };
    
    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      if(msg.data && msg.data.s) {
        const symbol = msg.data.s.replace('USDT','');
        handleTick(symbol, parseFloat(msg.data.p), msg.data.T);
      }
    };
  }

  function subscribeWS(symbol) {
    if(ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ method: "SUBSCRIBE", params: [`${symbol.toLowerCase()}usdt@trade`], id: Date.now() }));
    }
  }

  // --- UTILS ---
  function fmt(n) { 
    return (n * state.rate).toLocaleString(undefined, { 
      style: 'currency', 
      currency: state.currency === 'USDT' ? 'USD' : state.currency 
    }); 
  }

  // --- EVENTS ---
  document.getElementById('addCoinBtn').addEventListener('click', () => {
    const val = document.getElementById('newCoinInput').value.toUpperCase().trim();
    if(val && !state.coins[val]) {
      initCoin(val);
      document.getElementById('newCoinInput').value = '';
    }
  });
  
  // Enter key support for input
  document.getElementById('newCoinInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') document.getElementById('addCoinBtn').click();
  });

  document.getElementById('currencySelector').addEventListener('change', (e) => {
    state.currency = e.target.value;
    state.rate = e.target.value === 'INR' ? 86.5 : 1;
    Object.values(state.coins).forEach(c => { c.history = []; c.labels = []; }); // Reset histories
    chart.data.datasets[0].data = [];
    chart.update();
  });

  document.getElementById('pauseBtn').addEventListener('click', function(){
    state.paused = !state.paused;
    this.textContent = state.paused ? 'Resume' : 'Pause';
  });

  document.getElementById('clearBtn').addEventListener('click', () => location.reload());

  // Init
  CONFIG.defaultCoins.forEach(initCoin);
  connect();

})();
</script>
</body>
</html>
