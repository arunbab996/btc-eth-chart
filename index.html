<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Magic Internet Money | Quant Terminal</title>
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23f7931a'/><text x='50' y='62' font-size='56' text-anchor='middle' fill='white'>à¸¿</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- QUANT THEME --- */
    :root { 
      --bg: #000000;          
      --panel: #0b0b0b;       
      --border: #1a1a1a;      
      --text: #e5e5e5; 
      --text-dim: #666;
      --accent: #00E5FF; /* Cyan Neon */
      --green: #0ecb81;     
      --red: #f6465d;      
      --font: 'Inter', system-ui, sans-serif;
      --mono: 'IBM Plex Mono', 'Menlo', monospace;
    }

    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; overflow: hidden; }

    /* LAYOUT */
    .dashboard {
      display: grid;
      height: 100vh;
      grid-template-rows: 54px 1fr;
      grid-template-columns: 260px 1fr 320px;
      grid-template-areas: "head head head" "side main feed";
    }

    /* 1. HEADER */
    .appbar {
      grid-area: head; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 18px;
    }
    .brand { font-weight: 800; font-size: 14px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; color: #fff; text-shadow: 0 0 10px rgba(0,229,255,0.3); }
    .live-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 8px var(--accent); }
    .tag { background: #051a1d; color: var(--accent); border: 1px solid #0a3a40; font-size: 9px; padding: 2px 6px; border-radius: 4px; font-family: var(--mono); letter-spacing: 1px; }

    /* 2. SIDEBAR */
    .sidebar { grid-area: side; background: #050505; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
    .sec-head { 
      padding: 12px 16px; font-size: 10px; font-weight: 700; color: var(--text-dim); 
      text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border);
      background: var(--panel); display: flex; justify-content: space-between;
    }
    .coin-list { flex: 1; overflow-y: auto; }
    .coin-row { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 10px 16px; cursor: pointer; border-left: 2px solid transparent; 
      font-size: 13px; transition: background 0.1s; border-bottom: 1px solid #0e0e0e;
    }
    .coin-row:hover { background: #111; }
    .coin-row.active { background: #0a1f22; border-left-color: var(--accent); }
    
    /* 3. MAIN */
    .main-panel { grid-area: main; display: flex; flex-direction: column; position: relative; min-width: 0; }
    
    .kpi-bar { display: grid; grid-template-columns: repeat(4, 1fr); border-bottom: 1px solid var(--border); background: var(--panel); height: 80px; }
    .kpi-box { padding: 0 24px; border-right: 1px solid var(--border); display: flex; flex-direction: column; justify-content: center; }
    .kpi-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 700; margin-bottom: 6px; }
    .kpi-val { font-family: var(--mono); font-size: 20px; font-weight: 500; letter-spacing: -0.5px; }

    /* Chart Area */
    .chart-container { flex: 1; position: relative; width: 100%; background: var(--bg); }

    /* 4. FEED */
    .feed-panel { grid-area: feed; background: #050505; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
    .feed-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; }
    .trade-row { 
      display: grid; grid-template-columns: 50px 1fr 60px; gap: 10px;
      padding: 6px 14px; font-family: var(--mono); font-size: 10px; 
      color: var(--text-dim); border-bottom: 1px solid #0e0e0e; align-items: center;
    }
    .trade-whale { background: rgba(0, 229, 255, 0.05); border-left: 2px solid var(--accent); }
    .trade-whale span { color: var(--accent) !important; font-weight: 700; }

    /* UTILS */
    .up { color: var(--green); } .down { color: var(--red); }
    
    /* System Log */
    .sys-log { height: 120px; border-top: 1px solid var(--border); padding: 10px; font-family: var(--mono); font-size: 10px; overflow-y: auto; color: #444; background: #020202; }
    .log-line { margin-bottom: 4px; }

    @media(max-width: 1000px){ .dashboard { display: flex; flex-direction: column; height: auto; overflow: auto; } .chart-container { height: 350px; } }
  </style>
</head>
<body>

  <div class="dashboard">
    <header class="appbar">
      <div class="brand">
        <div class="live-dot"></div>
        <span>MAGIC INTERNET MONEY</span>
        <span class="tag">QUANT v6.0</span>
      </div>
      <div>
        <select id="currency" style="background:#111; color:#fff; border:1px solid #333; padding:4px 8px; font-size:11px; border-radius:4px; font-family:var(--mono)">
          <option value="USDT">USDT</option>
          <option value="INR">INR</option>
        </select>
      </div>
    </header>

    <aside class="sidebar">
      <div class="sec-head">Market Watch</div>
      <div id="coinList" class="coin-list"></div>
      
      <div class="sec-head" style="border-top:1px solid var(--border)">Engine Log</div>
      <div id="sysLog" class="sys-log"></div>
    </aside>

    <main class="main-panel">
      <div class="kpi-bar">
        <div class="kpi-box">
          <div class="kpi-lbl">Mark Price</div>
          <div id="kpiPrice" class="kpi-val" style="color:#fff">---</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-lbl">24h Change</div>
          <div id="kpiChange" class="kpi-val">---</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-lbl">Volatility (StdDev)</div>
          <div id="kpiVol" class="kpi-val" style="color:var(--accent)">---</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-lbl">Session High</div>
          <div id="kpiHigh" class="kpi-val">---</div>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="chart"></canvas>
      </div>
    </main>

    <aside class="feed-panel">
      <div class="sec-head">
        <span>Order Stream</span>
        <span style="font-size:9px; opacity:0.5">> $10k flagged</span>
      </div>
      <div id="tradeFeed" class="feed-scroll"></div>
    </aside>
  </div>

<script>
(function(){
  // --- CONFIG ---
  const COINS = ['BTC', 'ETH', 'SOL', 'BNB', 'XRP', 'DOGE', 'ADA', 'AVAX', 'LINK'];
  const WHALE_THRESHOLD = 10000;
  
  const STATE = {
    active: 'BTC',
    currency: 'USDT',
    rate: 1,
    coins: {} 
  };

  // --- CHART (Bollinger Bands + Price) ---
  const ctx = document.getElementById('chart').getContext('2d');
  
  // Custom Plugin: Crosshair
  const crosshair = {
    id: 'crosshair',
    afterDatasetsDraw: (chart) => {
      if (chart.tooltip?._active?.length) {
        const x = chart.tooltip._active[0].element.x;
        const ctx = chart.ctx;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, chart.scales.y.top);
        ctx.lineTo(x, chart.scales.y.bottom);
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#00E5FF';
        ctx.setLineDash([4, 4]);
        ctx.stroke();
        ctx.restore();
      }
    }
  };

  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        // 0: Main Price Line
        {
          label: 'Price',
          data: [],
          borderColor: '#00E5FF',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.2,
          borderShadowColor: '#00E5FF', // Note: Chart.js needs external plugin for real shadow, simplifying here
          zIndex: 10
        },
        // 1: Upper Band (Bollinger)
        {
          label: 'Upper',
          data: [],
          borderColor: 'transparent',
          pointRadius: 0,
          fill: false,
          tension: 0.2
        },
        // 2: Lower Band (Bollinger) - Fills to Upper
        {
          label: 'Lower',
          data: [],
          borderColor: 'transparent',
          backgroundColor: 'rgba(0, 229, 255, 0.1)', // The "Cloud" Color
          fill: '-1', // Fill to dataset index 1 (Upper)
          pointRadius: 0,
          tension: 0.2
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: { 
          position: 'right', 
          grid: { color: '#1a1a1a' }, 
          ticks: { color: '#666', callback: v => v.toLocaleString() } 
        }
      }
    },
    plugins: [crosshair]
  });

  // --- BOLLINGER BAND LOGIC ---
  function calculateBollinger(prices, period = 20, multiplier = 2) {
    if (prices.length < period) return { upper: null, lower: null, std: 0 };
    
    // Simple Moving Average (SMA)
    const slice = prices.slice(-period);
    const sum = slice.reduce((a, b) => a + b, 0);
    const mean = sum / period;

    // Standard Deviation
    const squaredDiffs = slice.map(p => Math.pow(p - mean, 2));
    const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b, 0) / period;
    const stdDev = Math.sqrt(avgSquaredDiff);

    return {
      upper: mean + (stdDev * multiplier),
      lower: mean - (stdDev * multiplier),
      std: stdDev
    };
  }

  // --- MAIN LOGIC ---
  function init() {
    log('Booting Quant Engine...');
    const list = document.getElementById('coinList');
    
    COINS.forEach(sym => {
      STATE.coins[sym] = { 
        price: 0, prev: 0, high: 0, 
        history: [], upper: [], lower: [], labels: [] 
      };
      
      const row = document.createElement('div');
      row.className = 'coin-row';
      row.id = `row-${sym}`;
      row.onclick = () => loadCoin(sym);
      row.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px">
          <img src="https://cdn.jsdelivr.net/npm/cryptocurrency-icons@0.18.1/svg/color/${sym.toLowerCase()}.svg" width="16" onerror="this.style.display='none'">
          <b style="font-family:var(--mono)">${sym}</b>
        </div>
        <div style="text-align:right">
          <div id="p-${sym}" style="font-family:var(--mono)">...</div>
        </div>
      `;
      list.appendChild(row);
    });
    
    connect();
    setTimeout(() => loadCoin('BTC'), 500);
  }

  function loadCoin(sym) {
    document.querySelectorAll('.coin-row').forEach(r => r.classList.remove('active'));
    document.getElementById(`row-${sym}`).classList.add('active');
    
    STATE.active = sym;
    log(`Analysis Target: ${sym}`);
    document.getElementById('tradeFeed').innerHTML = ''; 
    
    // Clear Chart
    chart.data.datasets[0].data = [];
    chart.data.datasets[1].data = [];
    chart.data.datasets[2].data = [];
    chart.update();
  }

  function handleTick(sym, price, time) {
    const coin = STATE.coins[sym];
    coin.prev = coin.price;
    coin.price = price;
    if(price > coin.high) coin.high = price;

    // UI Sidebar
    const pEl = document.getElementById(`p-${sym}`);
    if(pEl) {
      pEl.textContent = fmt(price);
      pEl.style.color = price >= coin.prev ? '#0ecb81' : '#f6465d';
    }

    // Active Coin Updates
    if(sym === STATE.active) {
      // 1. Chart History
      coin.history.push(price);
      coin.labels.push(new Date(time).toLocaleTimeString());
      
      // 2. Calculate Bollinger Bands
      const bb = calculateBollinger(coin.history, 20, 2);
      coin.upper.push(bb.upper);
      coin.lower.push(bb.lower);

      if(coin.history.length > 100) {
        coin.history.shift(); coin.labels.shift();
        coin.upper.shift(); coin.lower.shift();
      }
      
      chart.data.datasets[0].data = coin.history; // Price
      chart.data.datasets[1].data = coin.upper;   // Upper Band
      chart.data.datasets[2].data = coin.lower;   // Lower Band
      chart.data.labels = coin.labels;
      
      // Auto-Scale
      const validUpper = coin.upper.filter(n => n); // remove nulls
      const validLower = coin.lower.filter(n => n);
      if(validUpper.length && validLower.length) {
         const min = Math.min(...validLower);
         const max = Math.max(...validUpper);
         const pad = (max - min) * 0.1;
         chart.options.scales.y.min = min - pad;
         chart.options.scales.y.max = max + pad;
      } else if (coin.history.length > 0) {
         // Fallback before BB calc is ready
         const min = Math.min(...coin.history);
         const max = Math.max(...coin.history);
         chart.options.scales.y.min = min * 0.9995;
         chart.options.scales.y.max = max * 1.0005;
      }

      chart.update();

      // 3. KPI Updates
      document.getElementById('kpiPrice').textContent = fmt(price);
      document.getElementById('kpiHigh').textContent = fmt(coin.high);
      document.getElementById('kpiVol').textContent = bb.std ? bb.std.toFixed(2) : '---';
      
      if(coin.prev) {
        const pct = ((price - coin.prev)/coin.prev)*100;
        const el = document.getElementById('kpiChange');
        el.textContent = (pct>0?'+':'') + pct.toFixed(2) + '%';
        el.style.color = pct>=0 ? '#0ecb81' : '#f6465d';
      }
      
      document.title = `${fmt(price)} ${sym} | MIM`;
    }
  }

  function addTrade(sym, price, qty, time, isMaker) {
    if(sym !== STATE.active) return;
    
    const val = price * qty;
    const isWhale = val > WHALE_THRESHOLD;
    
    const row = document.createElement('div');
    row.className = `trade-row ${isWhale ? 'trade-whale' : ''}`;
    const ts = new Date(time).toLocaleTimeString().split(' ')[0];
    const typeClass = isMaker ? 'down' : 'up'; 
    
    row.innerHTML = `
      <span>${ts}</span>
      <span class="${typeClass}">${fmt(price)}</span>
      <span>${isWhale ? 'ðŸ‹ ' : ''}${val > 1000 ? (val/1000).toFixed(1)+'k' : val.toFixed(0)}</span>
    `;
    
    const feed = document.getElementById('tradeFeed');
    feed.prepend(row);
    if(feed.children.length > 50) feed.lastChild.remove();
  }

  function connect() {
    log('Connecting to Exchange Stream...');
    const streams = COINS.map(c => c.toLowerCase()+'usdt@trade').join('/');
    const ws = new WebSocket(`wss://stream.binance.com/stream?streams=${streams}`);
    
    ws.onopen = () => log('Data Stream Active.', '#00E5FF');
    ws.onclose = () => { log('Connection lost. Retry in 3s...', '#f6465d'); setTimeout(connect, 3000); };
    
    ws.onmessage = (e) => {
      const msg = JSON.parse(e.data);
      if(!msg.data) return;
      const { s: symbolRaw, p: price, q: qty, m: isMaker, T: time } = msg.data;
      const sym = symbolRaw.replace('USDT','');
      
      handleTick(sym, parseFloat(price), time);
      addTrade(sym, parseFloat(price), parseFloat(qty), time, isMaker);
    };
  }

  // --- UTILS ---
  function log(msg, color='#666') {
    const box = document.getElementById('sysLog');
    const div = document.createElement('div');
    div.className = 'log-line';
    div.style.color = color;
    div.innerHTML = `> ${msg}`;
    box.prepend(div);
  }

  function fmt(n) { 
    return (n * STATE.rate).toLocaleString('en-US', {
      style:'currency', currency: STATE.currency==='USDT'?'USD':'INR'
    }); 
  }

  document.getElementById('currency').onchange = (e) => {
    STATE.currency = e.target.value;
    STATE.rate = STATE.currency === 'INR' ? 86.5 : 1;
    log(`Currency rebased to ${STATE.currency}`);
    Object.values(STATE.coins).forEach(c => { c.history=[]; c.upper=[]; c.lower=[]; });
  };

  init();

})();
</script>
</body>
</html>
