<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Magic Internet Money</title>

  <!-- favicon (bitcoin) -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23f7931a'/><text x='50' y='62' font-size='56' text-anchor='middle' fill='white'>฿</text></svg>">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
    /* Fullscreen Bloomberg-style layout (A) */
    :root{
      --bg:#071018; --panel:#0d1114; --muted:#9aa3ad; --text:#dbe6ee; --accent:#f7931a; --eth:#627eea; --grid:#172024;
      --gutter:16px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}

    /* root container fills the viewport, no vertical scroll */
    .root{height:100vh;display:flex;flex-direction:column}

    /* top bar - thin */
    header.appbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));}
    header .title{font-size:16px;font-weight:600}
    header .subtitle{font-size:12px;color:var(--muted)}

    /* main area: split 75% chart, 25% sidebar */
    .main{flex:1;display:flex;gap:var(--gutter);padding:18px;box-sizing:border-box}

    .chart-panel{flex:3;display:flex;flex-direction:column;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px;padding:12px;overflow:hidden}
    .chart-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:8px}
    .chart-title{font-size:14px;font-weight:700}
    .chart-meta{font-size:13px;color:var(--muted)}

    .chart-canvas-wrap{flex:1;min-height:0;display:flex;align-items:stretch}
    canvas{width:100%!important;height:100%!important;display:block}

    .sidebar{flex:1;max-width:360px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,0.03);border-radius:10px;padding:12px}

    .coin-row{display:flex;align-items:center;gap:10px;cursor:pointer}
    .coin-row.inactive{opacity:0.55}
    .coin-icon{width:36px;height:36px;flex:0 0 36px}
    .coin-name{font-size:13px;color:var(--muted)}
    .coin-price{font-size:18px;font-weight:700}

    .controls{display:flex;flex-direction:column;gap:8px}
    select,input,button{background:#0b0f13;border:1px solid rgba(255,255,255,0.03);color:var(--text);padding:8px;border-radius:8px}
    .small{font-size:12px;color:var(--muted)}

    .footer{height:36px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:12px}

    /* responsive */
    @media(max-width:900px){ .main{padding:12px;flex-direction:column} .chart-panel{order:1} .sidebar{order:2;width:100%;max-width:none} }
  </style>
</head>
<body>
  <div class="root">
    <header class="appbar">
      <div>
        <div class="title">Magic Internet Money</div>
        <div class="subtitle">Live Tick Chart — BTC / ETH · Source: Binance WebSocket</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <label class="small" for="currencySelector">Currency</label>
        <select id="currencySelector" aria-label="Currency selector">
          <option value="USDT">USDT</option>
          <option value="USD">USD</option>
          <option value="INR">INR</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
        <button id="pauseBtn">Pause</button>
      </div>
    </header>

    <div class="main">
      <section class="chart-panel">
        <div class="chart-header">
          <div>
            <div class="chart-title">Live Tick Chart — <span id="chartSymbol">BTC</span></div>
            <div class="chart-meta" id="priceStatus">BTC USDT: —</div>
          </div>
          <div class="chart-meta" id="last">Started: —</div>
        </div>

        <div class="chart-canvas-wrap">
          <canvas id="chart" aria-label="Live chart"></canvas>
        </div>

        <div style="height:8px"></div>
      </section>

      <aside class="sidebar">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-size:13px;font-weight:700">Watchlist</div>
            <div class="small">Live</div>
          </div>

          <div id="btcPanel" class="coin-row" role="button" aria-pressed="true">
            <div class="coin-icon" aria-hidden="true">
              <!-- crisp BTC circle -->
              <svg viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="b1" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#ffb26b"/><stop offset="1" stop-color="#f7931a"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#b1)"/><text x="32" y="38" font-size="28" font-family="Arial" text-anchor="middle" fill="#fff">฿</text></svg>
            </div>
            <div style="flex:1">
              <div class="coin-name">Bitcoin</div>
              <div id="btcLive" class="coin-price">—</div>
            </div>
            <div class="small" id="btcChange">—</div>
          </div>

          <hr style="border:none;height:8px">

          <div id="ethPanel" class="coin-row inactive" role="button" aria-pressed="false">
            <div class="coin-icon" aria-hidden="true">
              <!-- crisp ETH diamond -->
              <svg viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="e1" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#9fb1ff"/><stop offset="1" stop-color="#627eea"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#e1)"/><path d="M32 16 L22 32 L32 28 L42 32 Z M32 36 L22 32 L32 44 L42 32 Z" fill="#fff" transform="translate(0,0)"/></svg>
            </div>
            <div style="flex:1">
              <div class="coin-name">Ethereum</div>
              <div id="ethLive" class="coin-price">—</div>
            </div>
            <div class="small" id="ethChange">—</div>
          </div>
        </div>

        <div class="card controls">
          <div class="small">Options</div>
          <select id="maxPoints">
            <option value="200">200 ticks</option>
            <option value="400" selected>400 ticks</option>
            <option value="800">800 ticks</option>
          </select>
          <div style="display:flex;gap:8px">
            <button id="injectBtn">Inject sample</button>
            <button id="clearBtn">Clear</button>
          </div>
          <div class="small">Tip: If your custom domain proxies traffic (Cloudflare) WebSocket may be blocked. Use DNS-only while testing.</div>
        </div>

        <div class="card small">
          <div>Source: Binance WebSocket</div>
          <div id="lastUpdate" style="margin-top:6px;color:var(--muted)">Last update: —</div>
        </div>
      </aside>
    </div>

    <div class="footer">Magic Internet Money — live tick preview</div>
  </div>

<script>
// DOM ready
window.addEventListener('DOMContentLoaded', function(){
  // --- state ---
  let activeSymbol = 'BTC';
  let paused = false;
  let lastBTC = null, lastETH = null;
  let btcLabels = [], btcPrices = [], btcVolumes = [];
  let ethLabels = [], ethPrices = [], ethVolumes = [];
  let MAX_POINTS = 400;
  let currencySymbol = 'USDT';
  let currencyRate = 1;
  let cachedRates = null;

  // chart setup
  const ctx = document.getElementById('chart').getContext('2d');
  function safeGradient(ctx, area){
    try{
      if(!area || typeof area.top === 'undefined'){
        const g = ctx.createLinearGradient(0,0,0,200);
        g.addColorStop(0,'rgba(247,147,26,0.18)'); g.addColorStop(1,'rgba(247,147,26,0.02)');
        return g;
      }
      const g = ctx.createLinearGradient(0, area.top, 0, area.bottom);
      g.addColorStop(0,'rgba(247,147,26,0.30)'); g.addColorStop(1,'rgba(247,147,26,0.03)');
      return g;
    }catch(e){ const g = ctx.createLinearGradient(0,0,0,200); g.addColorStop(0,'rgba(247,147,26,0.18)'); g.addColorStop(1,'rgba(247,147,26,0.02)'); return g; }
  }

  const chartConfig = {
    type:'line', data:{ labels:[], datasets:[{ label:'price', data:[], borderColor:'#f7931a', backgroundColor:null, borderWidth:2.6, pointRadius:0, tension:0.28, fill:true }] },
    options:{ responsive:true, maintainAspectRatio:false, animation:{duration:80,easing:'linear'}, interaction:{mode:'index',intersect:false}, plugins:{legend:{display:false}, tooltip:{enabled:true}}, scales:{ x:{ ticks:{color:'#9aa3ad'}, grid:{color:'rgba(255,255,255,0.03)'} }, y:{ ticks:{color:'#9aa3ad'}, grid:{color:'rgba(255,255,255,0.03)'} } }
  };

  const chart = new Chart(ctx, chartConfig);
  window.liveChart = chart;

  function updateGradient(){ const area = chart.chartArea; chart.data.datasets[0].backgroundColor = safeGradient(ctx, area); }

  function toLocal(ts){ return new Date(ts).toLocaleTimeString(); }
  function fmt(n){ return n==null? '—' : Number(n).toLocaleString(); }

  function pushTick(sym, price, qty, ts = Date.now()){
    const label = toLocal(ts);
    if(sym === 'BTC'){ btcLabels.push(label); btcPrices.push(price); btcVolumes.push(qty||0); if(btcLabels.length > MAX_POINTS){ btcLabels.shift(); btcPrices.shift(); btcVolumes.shift(); } }
    else { ethLabels.push(label); ethPrices.push(price); ethVolumes.push(qty||0); if(ethLabels.length > MAX_POINTS){ ethLabels.shift(); ethPrices.shift(); ethVolumes.shift(); } }
  }

  function redraw(){
    if(paused) return;
    if(activeSymbol === 'BTC'){ chart.data.labels = btcLabels.slice(); chart.data.datasets[0].data = btcPrices.map(v=>v*currencyRate); }
    else { chart.data.labels = ethLabels.slice(); chart.data.datasets[0].data = ethPrices.map(v=>v*currencyRate); }
    updateGradient(); adjustY(); chart.update('none');
    document.getElementById('btcLive').textContent = fmt(lastBTC? lastBTC*currencyRate : null);
    document.getElementById('ethLive').textContent = fmt(lastETH? lastETH*currencyRate : null);
    document.getElementById('priceStatus').textContent = `${activeSymbol} ${currencySymbol}: ${fmt((activeSymbol==='BTC'?lastBTC:lastETH)? (activeSymbol==='BTC'? lastBTC*currencyRate : lastETH*currencyRate) : null)}`;
    document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
  }

  function adjustY(){ const arr = (activeSymbol==='BTC'?btcPrices:ethPrices).map(v=>v*currencyRate).filter(v=>v!=null && !isNaN(v)); if(!arr.length) return; const minV=Math.min(...arr), maxV=Math.max(...arr); const range=Math.max(maxV-minV, Math.max(1, Math.abs(maxV)*0.0001)); const pad=Math.max(range*0.02, 0.5); chart.options.scales.y.min = Math.max(0, minV - pad); chart.options.scales.y.max = maxV + pad; }

  // throttled redraw using requestAnimationFrame to ensure smoothness
  let rafScheduled = false;
  function schedule(){ if(rafScheduled) return; rafScheduled = true; requestAnimationFrame(()=>{ rafScheduled=false; redraw(); }); }

  // conversion helper (background)
  async function fetchRates(){ try{ const r = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=INR,EUR,GBP,JPY,AUD,SGD'); if(!r.ok) throw new Error('bad'); const j = await r.json(); return j.rates || null; }catch(e){ return null; } }
  async function loadRates(){ cachedRates = await fetchRates(); if(!cachedRates){ document.getElementById('convBadge').style.display = 'inline-block'; document.getElementById('convBadge').textContent = 'Conversion: unavailable'; } else { document.getElementById('convBadge').style.display = 'none'; } }

  // REST fallback
  let restTimer = null;
  async function fetchOnce(){ try{ const [b,e]= await Promise.all([ fetch('https://api.binance.com/api/v3/trades?symbol=BTCUSDT&limit=1'), fetch('https://api.binance.com/api/v3/trades?symbol=ETHUSDT&limit=1') ]); const ba = await b.json(); const ea = await e.json(); if(Array.isArray(ba) && ba.length){ const p = parseFloat(ba[0].price||ba[0].p); prevBTC=lastBTC; lastBTC=p; pushTick('BTC', p, parseFloat(ba[0].qty||ba[0].q||0), ba[0].time||Date.now()); } if(Array.isArray(ea) && ea.length){ const p2 = parseFloat(ea[0].price||ea[0].p); prevETH=lastETH; lastETH=p2; pushTick('ETH', p2, parseFloat(ea[0].qty||ea[0].q||0), ea[0].time||Date.now()); } schedule(); return true; }catch(err){ console.error('REST fetch err',err); return false; } }
  function startRest(immediate=false){ if(restTimer) return; if(immediate) fetchOnce(); restTimer = setInterval(fetchOnce, 5000); document.getElementById('lastUpdate').textContent = 'Last update: REST fallback'; }
  function stopRest(){ if(restTimer){ clearInterval(restTimer); restTimer=null; } }

  // WebSocket with quick fallback and guarded parsing
  let socket = null;
  function startWS(){ try{ const url = 'wss://stream.binance.com/stream?streams=btcusdt@trade/ethusdt@trade'; socket = new WebSocket(url); let opened=false; const t = setTimeout(()=>{ if(!opened){ console.warn('WS not open — starting REST'); startRest(true); } }, 1500);
    socket.onopen = function(){ opened=true; clearTimeout(t); stopRest(); document.getElementById('lastUpdate').textContent = 'Last update: websocket'; };
    socket.onmessage = function(evt){ try{ const msg = JSON.parse(evt.data); const data = msg.data || {}; const p = parseFloat(data.p || data.price); const q = parseFloat(data.q || data.qty || 0); const ts = data.T || data.time || Date.now(); if(msg.stream && msg.stream.indexOf('btcusdt')===0){ prevBTC=lastBTC; lastBTC=p; pushTick('BTC', p, q, ts); } else if(msg.stream && msg.stream.indexOf('ethusdt')===0){ prevETH=lastETH; lastETH=p; pushTick('ETH', p, q, ts); } schedule(); }catch(e){ console.error('WS parse', e); } };
    socket.onerror = function(err){ console.error('WS err',err); startRest(true); };
    socket.onclose = function(ev){ console.warn('WS closed',ev); startRest(true); };
  }catch(e){ console.error('WS start err',e); startRest(true); } }

  // UI wiring
  document.getElementById('btcPanel').addEventListener('click', function(){ activeSymbol='BTC'; document.getElementById('btcPanel').classList.remove('inactive'); document.getElementById('ethPanel').classList.add('inactive'); document.getElementById('chartSymbol').textContent='BTC'; schedule(); });
  document.getElementById('ethPanel').addEventListener('click', function(){ activeSymbol='ETH'; document.getElementById('ethPanel').classList.remove('inactive'); document.getElementById('btcPanel').classList.add('inactive'); document.getElementById('chartSymbol').textContent='ETH'; schedule(); });

  document.getElementById('pauseBtn').addEventListener('click', function(){ paused = !paused; this.textContent = paused? 'Resume' : 'Pause'; });
  document.getElementById('injectBtn').addEventListener('click', function(){ const now = Date.now(); for(let i=60;i>0;i--){ const ts = now - i*1000; const price = 60000 + Math.sin(i/6)*300 + (Math.random()-0.5)*60; pushTick('BTC', Number(price.toFixed(2)), Math.random()*3, ts); } schedule(); });
  document.getElementById('clearBtn').addEventListener('click', function(){ btcLabels=[];btcPrices=[];ethLabels=[];ethPrices=[]; schedule(); });
  document.getElementById('maxPoints').addEventListener('change', function(e){ MAX_POINTS = Number(e.target.value); });
  document.getElementById('currencySelector').addEventListener('change', function(e){ currencySymbol = e.target.value; schedule(); });

  // keyboard shortcuts
  window.addEventListener('keydown', function(e){ if(e.key==='1'){ document.getElementById('btcPanel').click(); } else if(e.key==='2'){ document.getElementById('ethPanel').click(); } });

  // handle resize to ensure chartArea updated and gradient applied
  let resizeTimer = null; window.addEventListener('resize', function(){ clearTimeout(resizeTimer); resizeTimer = setTimeout(function(){ updateGradientAndRedraw(); }, 150); });
  function updateGradientAndRedraw(){ try{ updateGradient(); schedule(); }catch(e){} }

  function updateGradient(){ const area = chart.chartArea; chart.data.datasets[0].backgroundColor = safeGradient(ctx, area); }

  // initial boot
  loadRates(); startWS(); // will fallback to REST quickly if needed
  document.getElementById('lastUpdate').textContent = 'Started: ' + new Date().toLocaleTimeString();

  // expose debug helpers
  window._debug = { pushTick: pushTick, redraw: redraw, schedule: schedule, liveChart: chart };
});
</script>
</body>
</html>
